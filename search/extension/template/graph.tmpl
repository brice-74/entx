{{- define "graph" -}}
// Code generated by entx, DO NOT EDIT.

package entx

import (
  "fmt"
  "reflect"
  
  "entgo.io/ent/dialect/sql/sqlgraph"
  "entgo.io/ent/dialect/sql"
  "{{ entxImportPath }}"

  "{{ .EntGraph.Package }}"
  {{- range .Nodes }}
  "{{- printf "%s/%s" .EntNode.Config.Package .EntNode.Package -}}"
  {{- end }}
)

{{- $entxImportName := entxImportName -}}

{{- range .Nodes }}
{{ $NodeNameStruct := printf "%sNode" .NodeName }}
type {{ $NodeNameStruct }} struct {
	{{ $entxImportName }}.BaseNode
}

func new{{ $NodeNameStruct }}() *{{ $NodeNameStruct }} {
  cols := map[string]*{{ $entxImportName }}.Field{
    {{- range .Columns }}
    "{{ .Name }}": {Name:"{{ .Name }}", StorageName:"{{ .StorageKey }}"},
    {{- end }}
  }
  pks := []*{{ $entxImportName }}.Field{
    {{- range .PKs }}
    cols["{{ .Name }}"],
    {{- end }}
  }
	return &{{ $NodeNameStruct }}{BaseNode: {{ $entxImportName }}.NewBaseNode(
    "{{ .NodeName }}",
    "{{ .TableName }}",
		make(map[string]{{ $entxImportName }}.Bridge),
		cols,
		pks,
  )}
}

func (n *{{ $NodeNameStruct }}) NewQuery(c {{ $entxImportName }}.Client) {{ $entxImportName }}.Query {
	return c.MustGetEntityClient(n).Query()
}

func (n *{{ $NodeNameStruct }}) Policy() ent.Policy {
  {{- if .HasPolicy }}
  return {{ .EntNode.Package }}.Policy
  {{- else }}
  return nil
  {{- end }}
}
{{- end }}

{{- range .BridgePairs }}
{{ template "bridge" .Forward }}
{{- if .Inverse }}
{{ template "bridge" .Inverse }}
{{- end }}
{{- end }}

var Graph = BuildGraph()

func BuildGraph() map[string]{{ $entxImportName }}.Node {
  {{- range .Nodes }}
  var {{ .LowerNodeName }}Node = new{{ .NodeName }}Node()
  {{- end }}
  {{ range .BridgePairs }}
  var {{ .Forward.LowerName }} = new{{ .Forward.Name }}({{ .Forward.LowerLeftNodeName }}Node, {{ .Forward.LowerRightNodeName }}Node)
  {{ .Forward.LowerLeftNodeName }}Node.SetBridge("{{ .Forward.RelName }}", {{ .Forward.LowerName }})
  {{- if .Inverse }}
  var {{ .Inverse.LowerName }} = new{{ .Inverse.Name }}({{ .Inverse.LowerLeftNodeName }}Node, {{ .Inverse.LowerRightNodeName }}Node)
  {{ .Inverse.LowerLeftNodeName }}Node.SetBridge("{{ .Inverse.RelName }}", {{ .Inverse.LowerName }})
  {{ .Forward.LowerName }}.SetInverse({{ .Inverse.LowerName }})
  {{ .Inverse.LowerName }}.SetInverse({{ .Forward.LowerName }})
  {{- end }}
  {{ end }}
  return map[string]{{ $entxImportName }}.Node{
    {{- range .Nodes }}
    "{{ .NodeName }}": {{ .LowerNodeName }}Node,
    {{- end }}
  }
}
{{ end }}

{{- define "bridge" }}
{{- $entxImportName := entxImportName -}}

// {{ .Name }} ({{ .RelType }}) left={{ .LeftNode.Name }}, right={{ .RightNode.Name }}
type {{ .Name }} struct {
  {{ $entxImportName }}.BaseBridge
}

func new{{ .Name }}(
  left {{ $entxImportName }}.Node, right {{ $entxImportName }}.Node,
) *{{ .Name }} {
  return &{{ .Name }}{
    BaseBridge: {{ $entxImportName }}.NewBaseBridge(
      left,
      right,
      nil,
      {{ $entxImportName }}.RelationInfos{
        RelType:         sqlgraph.{{ .RelType }},
        FinalLeftField:  "{{ .LeftField }}",
        FinalRightField: "{{ .RightField }}",
        PivotTable:      "{{ .PivotTable }}",
        PivotLeftField:  "{{ .PivotLeftField }}",
        PivotRightField: "{{ .PivotRightField }}",
      },
    ),
  }
}

func (*{{ .Name }}) Filter() func(*sql.Selector) {
  return {{ .LeftNode.Package }}.Has{{ .StructField }}()
}

func (*{{ .Name }}) FilterWith(predicates ...func(*sql.Selector)) func(*sql.Selector) {
  return {{ .LeftNode.Package }}.Has{{ .StructField }}With({{ $entxImportName }}.CombinePredicates(predicates...))
}

func (b *{{ .Name }}) Include(pq {{ $entxImportName }}.Query, cq func({{ $entxImportName }}.Query), handlers ...{{ $entxImportName }}.EntityHandler) {{ $entxImportName }}.Query {
	adapter, ok := pq.(*{{ .LeftNode.QueryName }})
	if !ok {
		panic(fmt.Sprintf("{{ .Name }}.Include expect *{{ .LeftNode.QueryName }} as Query, got: %s", reflect.TypeOf(pq)))
	}

	adapter.{{ .LeftNode.QueryName }}.With{{ .StructField }}(func(q *ent.{{ .RightNode.QueryName }}) {
		cq(&{{ .RightNode.QueryName }}{q.AppendInterceptors({{ $entxImportName }}.ToInterceptor[*ent.{{ .RightNode.Name }}](handlers...))})
	})
	return adapter
}
{{- end }}